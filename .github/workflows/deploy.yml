name: Deploy Web Dashboard

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ~/lecture_dashboard

            # 최신 코드 강제 동기화 (로컬 변경사항 무시)
            git fetch origin main
            git reset --hard origin/main

            # .env.dev 파일 생성 (GitHub Secrets에서)
            cat > .env.dev << EOF
            MYSQL_HOST=${{ secrets.MYSQL_HOST }}
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            EOF

            # docker-compose.yml 네트워크 설정 (서버 환경에 맞게)
            sed -i 's/name: course_scraper_default/name: fastcampus-cralwer_default/' docker-compose.yml 2>/dev/null || true

            # 외부 네트워크가 없으면 생성
            docker network create fastcampus-cralwer_default 2>/dev/null || true
            docker network create db_mysql-network 2>/dev/null || true

            # Docker 컨테이너 재빌드 및 실행
            docker-compose down || true
            docker-compose up -d --build

            # MySQL 컨테이너를 mysql-network에 연결 (이미 연결되어 있으면 무시)
            docker network connect db_mysql-network mysql-server 2>/dev/null || true

            # 정리 (오래된 이미지 삭제)
            docker image prune -f

            echo "Web Dashboard deployment completed!"
