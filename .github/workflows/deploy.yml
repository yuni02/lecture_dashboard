name: Deploy to Server

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushí•  ë•Œ ìë™ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment archive
        run: |
          tar -czf lecture_dashboard.tar.gz \
            --exclude='venv' \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.idea' \
            --exclude='.claude' \
            --exclude='*.pyc' \
            --exclude='.env.local' \
            --exclude='deploy.sh' \
            --exclude='deploy-docker.sh' \
            --exclude='server-config.sh' \
            backend/ frontend/ .env.example .env.dev Dockerfile docker-compose.yml .dockerignore

      - name: Upload to server
        run: |
          scp -P ${{ secrets.SERVER_PORT }} \
            lecture_dashboard.tar.gz \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/

      - name: Deploy with Docker on server
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e

            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/lecture_dashboard
            cd ~/lecture_dashboard

            # ì••ì¶• í•´ì œ
            tar -xzf ~/lecture_dashboard.tar.gz
            rm ~/lecture_dashboard.tar.gz

            # Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "âŒ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker compose down 2>/dev/null || docker-compose down 2>/dev/null || true

            # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            if command -v docker-compose &> /dev/null; then
              docker-compose up -d --build
            else
              docker compose up -d --build
            fi

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps | grep lecture_dashboard || echo "ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "ğŸŒ ë°°í¬ ì™„ë£Œ: http://${{ secrets.SERVER_HOST }}:8000"
          echo "ğŸ“ ë¡œê·¸ í™•ì¸: ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'docker logs -f lecture_dashboard'"
